<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jira Task Oluşturucu (Python Backend)</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f5f5;
            padding-bottom: 50px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-header {
            font-weight: 600;
        }
        .card-header.collapsible {
            cursor: pointer;
        }
        .task-row input, .task-row textarea {
            font-size: 0.9rem;
        }
        .btn-delete {
            padding: 0.25rem 0.5rem;
        }
        .saved-badge {
            font-size: 0.8rem;
        }
        .task-preview {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        .server-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            z-index: 1000;
        }
        .server-status.connected {
            background: #198754;
            color: white;
        }
        .server-status.disconnected {
            background: #dc3545;
            color: white;
        }
        .paste-zone {
            border: 2px dashed transparent;
            transition: all 0.2s;
        }
        .paste-zone:focus {
            border-color: #0d6efd;
            background-color: #f0f7ff;
            outline: none;
        }
        .paste-zone:focus .paste-hint {
            color: #0d6efd !important;
            font-weight: 500;
        }
        .pasted-preview img {
            border: 1px solid #dee2e6;
        }
        .pasted-item {
            position: relative;
            display: inline-block;
        }
        .pasted-item .delete-pasted {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #dc3545;
            color: white;
            border: none;
            font-size: 10px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pasted-item .delete-pasted:hover {
            background: #bb2d3b;
        }
        .image-thumb {
            width: 80px;
            height: 80px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .image-thumb:hover, .image-thumb.active {
            border-color: #0d6efd;
            transform: scale(1.05);
        }
        .image-thumb-container {
            position: relative;
        }
        .image-thumb-container .delete-thumb {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #dc3545;
            color: white;
            border: 2px solid white;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .btn-view-images {
            padding: 2px 6px;
            font-size: 0.75rem;
        }
        /* Toast Container */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }
        .custom-toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-top: 10px;
            animation: slideIn 0.3s ease;
        }
        .custom-toast.toast-success { border-left: 4px solid #198754; }
        .custom-toast.toast-danger { border-left: 4px solid #dc3545; }
        .custom-toast.toast-warning { border-left: 4px solid #ffc107; }
        .custom-toast.toast-info { border-left: 4px solid #0dcaf0; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .custom-toast.hiding {
            animation: slideOut 0.3s ease forwards;
        }
        .custom-toast .toast-close-btn {
            width: 28px;
            height: 28px;
            min-width: 28px;
            padding: 0;
            border: none;
            background: transparent;
            color: #6c757d;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 16px;
            transition: all 0.2s;
            pointer-events: auto;
            position: relative;
            z-index: 10;
        }
        .custom-toast .toast-close-btn:hover {
            background: rgba(0,0,0,0.1);
            color: #000;
        }
        .custom-toast .toast-close-btn i {
            pointer-events: none;
        }
        /* History */
        .history-item {
            border-left: 3px solid #0d6efd;
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
        }
        .history-item:hover {
            background: #e9ecef;
        }
        .history-date {
            font-size: 0.75rem;
            color: #6c757d;
        }
        .history-task-list {
            margin-top: 8px;
            padding-left: 0;
            list-style: none;
        }
        .history-task-list li {
            padding: 4px 8px;
            margin-bottom: 4px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .history-task-list li:hover {
            background: #dee2e6;
        }
        .history-task-key {
            font-weight: 600;
            color: #0d6efd;
            white-space: nowrap;
        }
        .history-task-summary {
            color: #495057;
            flex: 1;
            word-break: break-word;
        }
        /* History Modal - Sabit Boyut */
        #historyModal .modal-dialog {
            max-width: 70vw;
            width: 70vw;
        }
        #historyModal .modal-content {
            height: 70vh;
            display: flex;
            flex-direction: column;
        }
        #historyModal .modal-body {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        /* ==================== Sayfa Navigasyonu ==================== */
        .page-nav-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .page-nav-item {
            padding: 8px 12px;
            margin-bottom: 4px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
        }
        .page-nav-item .page-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .page-nav-item .badge {
            margin-left: 8px;
            flex-shrink: 0;
        }
        .page-nav-item:hover {
            background: #e9ecef;
        }
        .page-nav-item.active {
            background: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }
        .page-nav-item.active .page-status-icon i {
            color: white !important;
        }
        .page-nav-item.completed {
            background: #d4edda;
            border-color: #28a745;
        }
        .page-nav-item.completed .page-status-icon i {
            color: #198754;
        }
        .page-nav-item.active.completed {
            background: #198754;
            color: white;
        }
        .page-nav-item.active.completed .page-status-icon i {
            color: white !important;
        }
        .page-status-icon {
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        .module-header {
            padding: 10px 12px;
            font-weight: 600;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .module-header:hover {
            background: #e9ecef;
        }
        .module-header .badge {
            font-size: 0.7rem;
        }
        .module-pages {
            margin-left: 15px;
            margin-bottom: 10px;
        }
        .current-page-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .current-page-info h5 {
            margin-bottom: 8px;
            font-weight: 600;
        }
        .current-page-info .page-path {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        .page-nav-card {
            position: sticky;
            top: 20px;
        }
        /* JSON Modu göstergesi */
        .json-mode-indicator {
            display: none;
        }
        .json-mode-indicator.active {
            display: block;
        }
        /* Manuel mod göstergesi */
        .manual-mode-indicator {
            display: block;
        }
        .manual-mode-indicator.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Server Status Badge -->
    <div id="serverStatus" class="server-status disconnected">
        <i class="bi bi-circle-fill"></i> <span>Python Server: Bağlanıyor...</span>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-kanban"></i> Jira Task Oluşturucu
                <small class="badge bg-success">Python Backend</small>
            </span>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-warning" id="openJsonImportBtn" data-bs-toggle="modal" data-bs-target="#jsonImportModal">
                    <i class="bi bi-file-earmark-code"></i> JSON İçe Aktar
                </button>
                <button type="button" class="btn btn-success" id="downloadJsonBtn" style="display:none;">
                    <i class="bi bi-download"></i> JSON İndir
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- Bağlantı Ayarları -->
        <div class="card">
            <div class="card-header bg-secondary text-white collapsible" data-bs-toggle="collapse" data-bs-target="#connectionSettings">
                <i class="bi bi-gear"></i> Bağlantı Ayarları
                <span id="connectionBadge" class="badge bg-success ms-2 saved-badge" style="display:none;">
                    <i class="bi bi-check"></i> Kayıtlı
                </span>
                <i class="bi bi-chevron-down float-end"></i>
            </div>
            <div class="collapse show" id="connectionSettings">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Jira Base URL</label>
                            <input type="url" class="form-control" id="jiraUrl" placeholder="https://jira.sirket.com">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="jiraUsername" placeholder="kullanici.adi">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">API Token / Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="jiraToken" placeholder="Token veya şifre">
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">Auth Tipi</label>
                            <select class="form-select" id="authType">
                                <option value="bearer">Bearer (PAT)</option>
                                <option value="basic">Basic Auth</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="saveConnection">
                        <i class="bi bi-save"></i> Kaydet
                    </button>
                    <button class="btn btn-success ms-2" id="testConnection">
                        <i class="bi bi-wifi"></i> Bağlantıyı Test Et
                    </button>
                    <button class="btn btn-outline-danger ms-2" id="clearConnection">
                        <i class="bi bi-trash"></i> Temizle
                    </button>
                </div>
            </div>
        </div>

        <!-- Ortak Task Bilgileri -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <i class="bi bi-file-earmark-text"></i> Ortak Task Bilgileri
                <button class="btn btn-sm btn-light float-end" id="loadFromApi" title="API'den Yükle">
                    <i class="bi bi-cloud-download"></i> API'den Yükle
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Proje</label>
                        <select class="form-select" id="projectKey">
                            <option value="">-- Proje Seçin --</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Bileşen</label>
                        <select class="form-select" id="component">
                            <option value="">-- Bileşen Seçin --</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Müşteri <span class="text-danger">*</span></label>
                        <select class="form-select" id="customer">
                            <option value="">-- Müşteri Seçin --</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Takım Adı <span class="text-danger">*</span></label>
                        <select class="form-select" id="teamName">
                            <option value="">-- Takım Seçin --</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Kayıt Tipi</label>
                        <select class="form-select" id="issueType">
                            <option value="">-- Kayıt Tipi Seçin --</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Epic Link</label>
                        <select class="form-select" id="epicLink">
                            <option value="">-- Epic Seçin --</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Öncelik</label>
                        <select class="form-select" id="priority">
                            <option value="">-- Öncelik Seçin --</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Title Başlangıcı</label>
                        <input type="text" class="form-control" id="titlePrefix"
                            placeholder="İlan Reklam/Bölge İşlemleri Sayfası içerisinde yer alan">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Açıklama Başlangıcı</label>
                        <textarea class="form-control" id="descriptionPrefix" rows="2"
                            placeholder="İlan/Reklam Vergisi Takip Sistemi içerisinde yer alan..."></textarea>
                    </div>
                </div>
                <button class="btn btn-info text-white" id="saveCommonSettings">
                    <i class="bi bi-save"></i> Ortak Ayarları Kaydet
                </button>
            </div>
        </div>

        <!-- Sol Panel (Sayfa Navigasyonu) + Sağ Panel (Task Listesi) -->
        <div class="row">
            <!-- Sol Panel: Sayfa Navigasyonu (JSON modunda görünür) -->
            <div class="col-md-3 json-mode-indicator" id="pageNavPanel">
                <div class="card page-nav-card">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-list-nested"></i> Sayfalar
                        <span class="badge bg-light text-primary float-end" id="pageProgressBadge">0/0</span>
                    </div>
                    <div class="card-body p-2">
                        <div class="page-nav-container" id="pageNavContainer">
                            <!-- Sayfa navigasyonu buraya dinamik olarak eklenecek -->
                            <p class="text-muted text-center small">JSON yükleyin</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sağ Panel: Task Listesi -->
            <div class="col-md-12" id="taskListPanel">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-list-task"></i> Task Listesi
                        <span class="json-mode-indicator float-end" id="currentPageBadge"></span>
                    </div>
                    <div class="card-body">
                        <!-- Aktif Sayfa Bilgisi (JSON modunda görünür) -->
                        <div class="current-page-info json-mode-indicator" id="currentPageInfo">
                            <h5 id="currentPageTitle">Sayfa seçin</h5>
                            <div class="page-path" id="currentPagePath"></div>
                        </div>

                        <!-- Task Ekle butonları - her iki modda da görünür -->
                        <button class="btn btn-success mb-3" id="addTask">
                            <i class="bi bi-plus-circle"></i> Task Ekle
                        </button>
                        <button class="btn btn-info mb-3 ms-2" id="addTestArayuzTasks">
                            <i class="bi bi-layers"></i> Test+Arayüz
                        </button>

                        <!-- Task Tablosu (Sadeleştirilmiş) -->
                        <div class="table-responsive">
                            <table class="table table-bordered" id="taskTable">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width:40px">#</th>
                                        <th>Title Sonu</th>
                                        <th style="width:100px">Süre (saat) <small class="text-muted">(opsiyonel)</small></th>
                                        <th>Açıklama Sonu</th>
                                        <th style="width:180px">Görsel</th>
                                        <th style="width:50px">Sil</th>
                                    </tr>
                                </thead>
                                <tbody id="taskTableBody">
                                    <!-- Dinamik satırlar buraya eklenecek -->
                                </tbody>
                            </table>
                        </div>

                        <!-- JSON Modu: Sayfa İşlem Butonları -->
                        <div class="json-mode-indicator mt-3" id="pageActionButtons">
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary" id="createPageTasksBtn">
                                    <i class="bi bi-cloud-upload"></i> Bu Sayfayı Oluştur
                                </button>
                                <button class="btn btn-outline-primary" id="nextPageBtn">
                                    Sonraki Sayfa <i class="bi bi-arrow-right"></i>
                                </button>
                                <button class="btn btn-outline-secondary" id="prevPageBtn">
                                    <i class="bi bi-arrow-left"></i> Önceki Sayfa
                                </button>
                            </div>
                            <!-- Task Oluşturma Progress Bar -->
                            <div class="mt-3 d-none" id="taskCreationProgress">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span id="taskProgressText">Task oluşturuluyor...</span>
                                </div>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                                         id="taskProgressBar" style="width: 0%">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- İşlem Butonları -->
        <div class="d-flex gap-2 mb-4 mt-3">
            <button class="btn btn-warning" id="previewBtn">
                <i class="bi bi-eye"></i> Önizle
            </button>
            <button class="btn btn-primary manual-mode-indicator" id="createBtn">
                <i class="bi bi-cloud-upload"></i> Tümünü Oluştur
            </button>
            <button class="btn btn-outline-secondary" id="historyBtn">
                <i class="bi bi-clock-history"></i> Geçmiş
                <span class="badge bg-secondary" id="historyCount">0</span>
            </button>
        </div>
        <!-- Manuel Mod: Task Oluşturma Progress Bar -->
        <div class="mb-4 d-none" id="manualTaskProgress">
            <div class="d-flex align-items-center mb-2">
                <span class="spinner-border spinner-border-sm me-2"></span>
                <span id="manualProgressText">Task oluşturuluyor...</span>
            </div>
            <div class="progress" style="height: 20px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                     id="manualProgressBar" style="width: 0%">0%</div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Önizleme Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="bi bi-eye"></i> Task Önizleme</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="previewContent">
                    <!-- Önizleme içeriği -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                    <button type="button" class="btn btn-primary" id="createFromPreview">
                        <i class="bi bi-cloud-upload"></i> Oluştur
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Görsel Önizleme Modal -->
    <div class="modal fade" id="imagePreviewModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-images"></i> Görseller</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Sol taraf: Küçük resimler -->
                        <div class="col-md-3 border-end" style="max-height:500px; overflow-y:auto;">
                            <div class="d-flex flex-wrap gap-2" id="imageThumbnails">
                                <!-- Küçük resimler buraya eklenecek -->
                            </div>
                        </div>
                        <!-- Sağ taraf: Büyük önizleme -->
                        <div class="col-md-9 text-center d-flex align-items-center justify-content-center" style="min-height:400px;">
                            <div id="imageLargePreview">
                                <p class="text-muted">Görüntülemek için bir görsel seçin</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title"><i class="bi bi-clock-history"></i> Task Geçmişi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="historyContent">
                    <!-- Geçmiş içeriği -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" id="clearHistory">
                        <i class="bi bi-trash"></i> Geçmişi Temizle
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JSON Import Modal -->
    <div class="modal fade" id="jsonImportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-code"></i> Refinement JSON Import
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <!-- Yükleme öncesi -->
                    <div id="jsonLoadSection">
                        <p class="text-muted mb-3">JSON dosyası seçerek task'ları yükleyin.<br>
                        <small>Değişiklikler otomatik kaydedilecek.</small></p>
                        <button type="button" class="btn btn-warning btn-lg" id="loadJsonBtn">
                            <i class="bi bi-folder2-open"></i> JSON Dosyası Seç
                        </button>
                    </div>

                    <!-- Preview section (yüklendikten sonra) -->
                    <div id="jsonPreview" style="display:none;">
                        <div class="alert alert-info text-start">
                            <strong>Yüklenen:</strong> <span id="jsonModulInfo"></span>
                            <span class="mx-2">|</span>
                            <strong>Sayfa:</strong> <span id="jsonPageCount"></span>
                            <span class="mx-2">|</span>
                            <strong>Toplam Task:</strong> <span id="jsonTaskCount"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" id="clearJsonBtn">
                        <i class="bi bi-x-circle"></i> Temizle
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
    $(document).ready(function() {
        // ==================== Python Server API URL ====================
        const API_BASE = ''; // Aynı sunucudan serve edildiği için boş

        // Server status kontrolü
        function checkServerStatus() {
            const jiraUrl = $('#jiraUrl').val();
            const token = $('#jiraToken').val();

            // Eğer URL veya token yoksa sadece server durumunu kontrol et
            if (!jiraUrl || !token) {
                // Token olmadan basit ping yap
                $.ajax({
                    url: '/api/jira/myself',
                    type: 'GET',
                    headers: {
                        'X-Jira-Url': jiraUrl || 'http://test',
                        'Authorization': 'Bearer test'
                    },
                    timeout: 3000,
                    success: function() {
                        $('#serverStatus').removeClass('disconnected').addClass('connected')
                            .html('<i class="bi bi-circle-fill"></i> <span>Python Server: Bağlı (Ayarlar eksik)</span>');
                    },
                    error: function(xhr) {
                        if (xhr.status === 400 || xhr.status === 401 || xhr.status === 500) {
                            $('#serverStatus').removeClass('disconnected').addClass('connected')
                                .html('<i class="bi bi-circle-fill"></i> <span>Python Server: Bağlı (Ayarlar eksik)</span>');
                        } else {
                            $('#serverStatus').removeClass('connected').addClass('disconnected')
                                .html('<i class="bi bi-circle-fill"></i> <span>Python Server: Bağlantı Yok!</span>');
                        }
                    }
                });
                return;
            }

            // Gerçek token ile kontrol
            const username = $('#jiraUsername').val().trim();
            const authType = $('#authType').val();
            let authHeader;
            if (authType === 'bearer') {
                authHeader = 'Bearer ' + token;
            } else {
                authHeader = 'Basic ' + btoa(`${username}:${token}`);
            }

            $.ajax({
                url: '/api/jira/myself',
                type: 'GET',
                headers: {
                    'X-Jira-Url': jiraUrl,
                    'Authorization': authHeader
                },
                timeout: 3000,
                success: function() {
                    $('#serverStatus').removeClass('disconnected').addClass('connected')
                        .html('<i class="bi bi-circle-fill"></i> <span>Python Server: Bağlı</span>');
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        $('#serverStatus').removeClass('disconnected').addClass('connected')
                            .html('<i class="bi bi-circle-fill"></i> <span>Python Server: Bağlı (Jira auth hatası)</span>');
                    } else if (xhr.status === 400 || xhr.status === 500) {
                        $('#serverStatus').removeClass('disconnected').addClass('connected')
                            .html('<i class="bi bi-circle-fill"></i> <span>Python Server: Bağlı</span>');
                    } else {
                        $('#serverStatus').removeClass('connected').addClass('disconnected')
                            .html('<i class="bi bi-circle-fill"></i> <span>Python Server: Bağlantı Yok!</span>');
                    }
                }
            });
        }

        // Sayfa yüklenince ve her 10 saniyede server kontrol et
        checkServerStatus();
        setInterval(checkServerStatus, 10000);

        // ==================== Select2 Initialize ====================
        const select2Config = {
            theme: 'bootstrap-5',
            width: '100%',
            allowClear: true,
            placeholder: function() {
                return $(this).data('placeholder');
            }
        };

        $('#projectKey').select2({...select2Config, placeholder: '-- Proje Seçin --'});
        $('#component').select2({...select2Config, placeholder: '-- Bileşen Seçin --'});
        $('#customer').select2({...select2Config, placeholder: '-- Müşteri Seçin --'});
        $('#teamName').select2({...select2Config, placeholder: '-- Takım Seçin --'});
        $('#issueType').select2({...select2Config, placeholder: '-- Kayıt Tipi Seçin --'});
        $('#epicLink').select2({...select2Config, placeholder: '-- Epic Seçin --'});
        $('#priority').select2({...select2Config, placeholder: '-- Öncelik Seçin --'});

        // ==================== API Helper (Python Backend üzerinden) ====================

        function getAuthHeader() {
            const username = $('#jiraUsername').val().trim();
            const token = $('#jiraToken').val().trim();
            const authType = $('#authType').val();

            if (authType === 'bearer') {
                return 'Bearer ' + token;
            } else {
                return 'Basic ' + btoa(`${username}:${token}`);
            }
        }

        function getJiraUrl() {
            return $('#jiraUrl').val().trim().replace(/\/$/, '');
        }

        // Python server üzerinden Jira API çağrısı
        async function jiraFetch(endpoint, options = {}) {
            const method = options.method || 'GET';

            const ajaxConfig = {
                url: `/api/jira/${endpoint.replace(/^\//, '')}`,
                type: method,
                contentType: 'application/json',
                headers: {
                    'X-Jira-Url': getJiraUrl(),
                    'Authorization': getAuthHeader()
                }
            };

            if (options.body) {
                ajaxConfig.data = options.body;
            }

            return new Promise((resolve, reject) => {
                $.ajax({
                    ...ajaxConfig,
                    success: function(data) {
                        resolve(data);
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON?.error || xhr.responseText || xhr.statusText;
                        reject(new Error(`${xhr.status} - ${errorMsg}`));
                    }
                });
            });
        }

        // ==================== LocalStorage Yönetimi ====================

        function loadConnectionSettings() {
            const url = localStorage.getItem('jira_url');
            const username = localStorage.getItem('jira_username');
            const token = localStorage.getItem('jira_token');
            const authType = localStorage.getItem('jira_authType');

            if (url) $('#jiraUrl').val(url);
            if (username) $('#jiraUsername').val(username);
            if (token) $('#jiraToken').val(token);
            if (authType) $('#authType').val(authType);

            if (url && token) {
                $('#connectionBadge').show();
                $('#connectionSettings').removeClass('show');
            }
        }

        function loadCommonSettings() {
            const projectKey = localStorage.getItem('jira_projectKey');
            const component = localStorage.getItem('jira_component');
            const customer = localStorage.getItem('jira_customer');
            const teamName = localStorage.getItem('jira_teamName');
            const issueType = localStorage.getItem('jira_issueType');
            const epicLink = localStorage.getItem('jira_epicLink');
            const priority = localStorage.getItem('jira_priority');
            const titlePrefix = localStorage.getItem('jira_titlePrefix');
            const descPrefix = localStorage.getItem('jira_descPrefix');

            window.savedSettings = { projectKey, component, customer, teamName, issueType, epicLink, priority };

            if (titlePrefix) $('#titlePrefix').val(titlePrefix);
            if (descPrefix) $('#descriptionPrefix').val(descPrefix);
        }

        loadConnectionSettings();
        loadCommonSettings();

        function applySavedSettings() {
            if (window.savedSettings) {
                if (window.savedSettings.projectKey) {
                    $('#projectKey').val(window.savedSettings.projectKey).trigger('change');
                    loadComponents(window.savedSettings.projectKey);
                    loadEpics(window.savedSettings.projectKey);
                }
                if (window.savedSettings.priority) {
                    $('#priority').val(window.savedSettings.priority).trigger('change');
                }
            }
        }

        function applyComponentAndEpicSettings() {
            if (window.savedSettings) {
                if (window.savedSettings.component) {
                    $('#component').val(window.savedSettings.component).trigger('change');
                }
                if (window.savedSettings.epicLink) {
                    $('#epicLink').val(window.savedSettings.epicLink).trigger('change');
                }
            }
        }

        // Müşteri ve Takım ayarlarını uygula
        function applyCustomFieldSettings() {
            if (window.savedSettings) {
                if (window.savedSettings.customer) {
                    $('#customer').val(window.savedSettings.customer).trigger('change');
                }
                if (window.savedSettings.teamName) {
                    $('#teamName').val(window.savedSettings.teamName).trigger('change');
                }
            }
        }

        // Bağlantı ayarlarını kaydet
        $('#saveConnection').click(function() {
            const url = $('#jiraUrl').val().trim();
            const username = $('#jiraUsername').val().trim();
            const token = $('#jiraToken').val().trim();
            const authType = $('#authType').val();

            if (!url || !token) {
                showResult('Lütfen URL ve Token bilgilerini doldurun.', 'danger');
                return;
            }

            localStorage.setItem('jira_url', url);
            localStorage.setItem('jira_username', username);
            localStorage.setItem('jira_token', token);
            localStorage.setItem('jira_authType', authType);

            $('#connectionBadge').show();
            showResult('Bağlantı ayarları kaydedildi.', 'success');
        });

        // Bağlantıyı test et
        $('#testConnection').click(async function() {
            const btn = $(this);
            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Test Ediliyor...');

            try {
                await jiraFetch('myself');
                showResult('Bağlantı başarılı! Python server üzerinden Jira\'ya bağlanıldı.', 'success');
            } catch (err) {
                showResult(`Bağlantı hatası: ${err.message}`, 'danger');
            }

            btn.prop('disabled', false).html('<i class="bi bi-wifi"></i> Bağlantıyı Test Et');
        });

        // Bağlantı ayarlarını temizle
        $('#clearConnection').click(function() {
            localStorage.removeItem('jira_url');
            localStorage.removeItem('jira_username');
            localStorage.removeItem('jira_token');
            localStorage.removeItem('jira_authType');

            $('#jiraUrl').val('');
            $('#jiraUsername').val('');
            $('#jiraToken').val('');
            $('#authType').val('bearer');
            $('#connectionBadge').hide();

            showResult('Bağlantı ayarları temizlendi.', 'info');
        });

        // Ortak ayarları kaydet
        $('#saveCommonSettings').click(function() {
            localStorage.setItem('jira_projectKey', $('#projectKey').val());
            localStorage.setItem('jira_component', $('#component').val());
            localStorage.setItem('jira_customer', $('#customer').val());
            localStorage.setItem('jira_teamName', $('#teamName').val());
            localStorage.setItem('jira_issueType', $('#issueType').val());
            localStorage.setItem('jira_epicLink', $('#epicLink').val());
            localStorage.setItem('jira_priority', $('#priority').val());
            localStorage.setItem('jira_titlePrefix', $('#titlePrefix').val());
            localStorage.setItem('jira_descPrefix', $('#descriptionPrefix').val());

            showResult('Ortak ayarlar kaydedildi.', 'success');
        });

        // Şifre göster/gizle
        $('#togglePassword').click(function() {
            const input = $('#jiraToken');
            const icon = $(this).find('i');

            if (input.attr('type') === 'password') {
                input.attr('type', 'text');
                icon.removeClass('bi-eye').addClass('bi-eye-slash');
            } else {
                input.attr('type', 'password');
                icon.removeClass('bi-eye-slash').addClass('bi-eye');
            }
        });

        // ==================== API'den Dropdown Yükleme ====================

        async function loadProjects() {
            const select = $('#projectKey');
            select.empty().append('<option value="">Yükleniyor...</option>').trigger('change');

            try {
                const projects = await jiraFetch('project');
                select.empty().append('<option value="">-- Proje Seçin --</option>');

                projects.forEach(project => {
                    select.append(`<option value="${project.key}">${project.key} - ${project.name}</option>`);
                });

                select.trigger('change');
                applySavedSettings();
            } catch (err) {
                select.empty().append('<option value="">Yüklenemedi</option>').trigger('change');
                console.error('Projeler yüklenemedi:', err);
            }
        }

        async function loadComponents(projectKey) {
            const select = $('#component');
            select.empty().append('<option value="">⏳ Bileşenler yükleniyor...</option>')
                .prop('disabled', true)
                .trigger('change');

            try {
                const components = await jiraFetch(`project/${projectKey}/components`);
                select.prop('disabled', false)
                    .empty()
                    .append('<option value="">-- Bileşen Seçin --</option>');

                components.forEach(comp => {
                    select.append(`<option value="${comp.name}">${comp.name}</option>`);
                });

                select.trigger('change');
                applyComponentAndEpicSettings();
            } catch (err) {
                select.prop('disabled', false)
                    .empty()
                    .append('<option value="">❌ Yüklenemedi</option>')
                    .trigger('change');
                console.error('Bileşenler yüklenemedi:', err);
            }
        }

        async function loadEpics(projectKey) {
            const select = $('#epicLink');
            select.empty().append('<option value="">⏳ Epicler yükleniyor...</option>')
                .prop('disabled', true)
                .trigger('change');

            try {
                const jql = encodeURIComponent(`project = ${projectKey} AND issuetype = Epic ORDER BY created DESC`);
                const result = await jiraFetch(`search?jql=${jql}&maxResults=100&fields=key,summary`);

                select.prop('disabled', false)
                    .empty()
                    .append('<option value="">-- Epic Seçin --</option>');

                result.issues.forEach(epic => {
                    select.append(`<option value="${epic.key}">${epic.key} - ${epic.fields.summary}</option>`);
                });

                select.trigger('change');
                applyComponentAndEpicSettings();
            } catch (err) {
                select.prop('disabled', false)
                    .empty()
                    .append('<option value="">❌ Yüklenemedi</option>')
                    .trigger('change');
                console.error('Epic\'ler yüklenemedi:', err);
            }
        }

        async function loadPriorities() {
            const select = $('#priority');
            select.empty().append('<option value="">Yükleniyor...</option>').trigger('change');

            try {
                const priorities = await jiraFetch('priority');
                select.empty().append('<option value="">-- Öncelik Seçin --</option>');

                // ID'yi value olarak kullan
                priorities.forEach(priority => {
                    select.append(`<option value="${priority.id}">${priority.name}</option>`);
                });

                if (window.savedSettings && window.savedSettings.priority) {
                    $('#priority').val(window.savedSettings.priority).trigger('change');
                } else {
                    select.trigger('change');
                }
            } catch (err) {
                select.empty().append('<option value="">Yüklenemedi</option>').trigger('change');
                console.error('Öncelikler yüklenemedi:', err);
            }
        }

        // Kayıt tiplerini yükle (proje bazlı)
        async function loadIssueTypes(projectKey) {
            const select = $('#issueType');
            select.empty().append('<option value="">⏳ Kayıt tipleri yükleniyor...</option>')
                .prop('disabled', true)
                .trigger('change');

            try {
                const project = await jiraFetch(`project/${projectKey}`);
                select.prop('disabled', false)
                    .empty()
                    .append('<option value="">-- Kayıt Tipi Seçin --</option>');

                if (project.issueTypes) {
                    project.issueTypes.forEach(type => {
                        // Sub-task tipini hariç tut (genellikle ayrı oluşturulur)
                        if (!type.subtask) {
                            select.append(`<option value="${type.name}">${type.name}</option>`);
                        }
                    });
                }

                // Kaydedilen değeri uygula
                if (window.savedSettings && window.savedSettings.issueType) {
                    $('#issueType').val(window.savedSettings.issueType).trigger('change');
                } else {
                    // Varsayılan olarak Task seç
                    $('#issueType').val('Task').trigger('change');
                }
            } catch (err) {
                select.prop('disabled', false)
                    .empty()
                    .append('<option value="">❌ Yüklenemedi</option>')
                    .trigger('change');
                console.error('Kayıt tipleri yüklenemedi:', err);
            }
        }

        // Müşteri ve Takım Adı alanlarını yükle (createmeta'dan)
        async function loadCustomFields(projectKey) {
            try {
                // Create meta endpoint ile alan seçeneklerini al
                const meta = await jiraFetch(`issue/createmeta?projectKeys=${projectKey}&issuetypeNames=Task&expand=projects.issuetypes.fields`);

                if (meta.projects && meta.projects.length > 0) {
                    const project = meta.projects[0];
                    if (project.issuetypes && project.issuetypes.length > 0) {
                        const taskType = project.issuetypes[0];
                        const fields = taskType.fields;

                        // Epic Link field ID'sini bul
                        window.epicLinkFieldId = null;
                        for (const [fieldId, fieldData] of Object.entries(fields)) {
                            if (fieldData.name && fieldData.name.toLowerCase().includes('epic link')) {
                                window.epicLinkFieldId = fieldId;
                                console.log('Epic Link field ID bulundu:', fieldId);
                                break;
                            }
                        }

                        // Müşteri alanı (customfield_10901)
                        if (fields.customfield_10901 && fields.customfield_10901.allowedValues) {
                            const customerSelect = $('#customer');
                            customerSelect.empty().append('<option value="">-- Müşteri Seçin --</option>');
                            fields.customfield_10901.allowedValues.forEach(val => {
                                customerSelect.append(`<option value="${val.value || val.name || val.id}">${val.value || val.name}</option>`);
                            });
                            customerSelect.trigger('change');
                        }

                        // Takım Adı alanı (customfield_11000)
                        if (fields.customfield_11000 && fields.customfield_11000.allowedValues) {
                            const teamSelect = $('#teamName');
                            teamSelect.empty().append('<option value="">-- Takım Seçin --</option>');
                            fields.customfield_11000.allowedValues.forEach(val => {
                                teamSelect.append(`<option value="${val.value || val.name || val.id}">${val.value || val.name}</option>`);
                            });
                            teamSelect.trigger('change');
                        }

                        // Kaydedilen değerleri uygula
                        applyCustomFieldSettings();
                    }
                }
            } catch (err) {
                console.error('Özel alanlar yüklenemedi:', err);
            }
        }

        $('#projectKey').on('change', function() {
            const projectKey = $(this).val();
            if (projectKey) {
                loadComponents(projectKey);
                loadEpics(projectKey);
                loadIssueTypes(projectKey);  // Kayıt tiplerini yükle
                loadCustomFields(projectKey);  // Müşteri ve Takım alanlarını yükle
            } else {
                $('#component').empty().append('<option value="">-- Bileşen Seçin --</option>').trigger('change');
                $('#epicLink').empty().append('<option value="">-- Epic Seçin --</option>').trigger('change');
                $('#issueType').empty().append('<option value="">-- Kayıt Tipi Seçin --</option>').trigger('change');
                $('#customer').empty().append('<option value="">-- Müşteri Seçin --</option>').trigger('change');
                $('#teamName').empty().append('<option value="">-- Takım Seçin --</option>').trigger('change');
            }
        });

        $('#loadFromApi').click(async function() {
            const btn = $(this);
            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Yükleniyor...');

            try {
                await Promise.all([loadProjects(), loadPriorities()]);
                showResult('Veriler API\'den yüklendi.', 'success');
            } catch (err) {
                showResult(`Veri yükleme hatası: ${err.message}`, 'danger');
            }

            btn.prop('disabled', false).html('<i class="bi bi-cloud-download"></i> API\'den Yükle');
        });

        // ==================== Dinamik Task Tablosu ====================

        var taskCounter = 0;
        // Yapıştırılan dosyaları sakla (file input'a programatik eklenemez)
        window.pastedFiles = {};

        // ==================== State Değişkenleri ====================
        var loadedJsonData = null;      // Yüklenen JSON verisi
        var currentPageIndex = -1;      // Aktif sayfa indeksi
        var completedPages = {};        // Tamamlanan sayfalar {pageIndex: true}
        var isJsonMode = false;         // JSON modu aktif mi?
        var jsonFileHandle = null;      // File System Access API için dosya handle'ı

        // Escape HTML karakterleri
        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Sadeleştirilmiş addTaskRow (prefix sütunları kaldırıldı)
        function addTaskRow(titleSuffix, hours, descSuffix) {
            taskCounter++;
            var rowId = taskCounter;
            window.pastedFiles[rowId] = [];

            // Varsayılan değerler
            titleSuffix = titleSuffix || '';
            hours = hours || '';
            descSuffix = descSuffix || '';

            var row = '<tr class="task-row" data-id="' + rowId + '">' +
                '<td class="text-center align-middle">' + rowId + '</td>' +
                '<td>' +
                    '<input type="text" class="form-control form-control-sm task-title-suffix" ' +
                        'placeholder="html kodlarının dönüştürülmesi" value="' + escapeHtml(titleSuffix) + '">' +
                '</td>' +
                '<td>' +
                    '<input type="number" class="form-control form-control-sm task-hours" ' +
                        'placeholder="Süre (saat)" value="' + hours + '">' +
                '</td>' +
                '<td>' +
                    '<input type="text" class="form-control form-control-sm task-desc-suffix" ' +
                        'placeholder="HTML kodlarının dönüşümü yapılacaktır." value="' + escapeHtml(descSuffix) + '">' +
                '</td>' +
                '<td class="paste-zone" tabindex="0" style="cursor:pointer;">' +
                    '<div class="d-flex align-items-center gap-1 mb-1">' +
                        '<input type="file" class="form-control form-control-sm task-image" ' +
                            'accept="image/*" multiple style="flex:1; font-size:0.7rem;">' +
                        '<button type="button" class="btn btn-outline-info btn-view-images btn-sm" title="Görselleri Görüntüle">' +
                            '<i class="bi bi-eye"></i>' +
                        '</button>' +
                    '</div>' +
                    '<div class="paste-hint text-muted small" style="font-size:0.7rem;">' +
                        '<i class="bi bi-clipboard"></i> Ctrl+V' +
                    '</div>' +
                    '<div class="pasted-preview mt-1"></div>' +
                    '<small class="text-muted task-image-info"></small>' +
                '</td>' +
                '<td class="text-center align-middle">' +
                    '<button class="btn btn-outline-danger btn-delete btn-sm" onclick="deleteRow(this)">' +
                        '<i class="bi bi-trash"></i>' +
                    '</button>' +
                '</td>' +
            '</tr>';

            $('#taskTableBody').append(row);
            updateRowNumbers();

            var $row = $('#taskTableBody tr:last');

            // Dosya seçildiğinde bilgi göster
            $row.find('.task-image').on('change', function() {
                updateFileInfo($row);
            });

            // Göz ikonuna tıkla - görselleri modal'da göster
            $row.find('.btn-view-images').on('click', function(e) {
                e.stopPropagation();
                openImagePreviewModal($row);
            });

            // Yapıştırma olayı (paste zone'a tıklayınca focus al)
            $row.find('.paste-zone').on('paste', function(e) {
                const items = (e.originalEvent.clipboardData || e.clipboardData).items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const blob = items[i].getAsFile();
                        const timestamp = new Date().getTime();
                        const file = new File([blob], `screenshot_${timestamp}.png`, { type: blob.type });

                        const currentRowId = $row.data('id');
                        const fileIndex = window.pastedFiles[currentRowId].length;
                        window.pastedFiles[currentRowId].push(file);

                        // Önizleme göster (silme butonu ile)
                        const reader = new FileReader();
                        reader.onload = function(ev) {
                            $row.find('.pasted-preview').append(
                                `<span class="pasted-item" data-index="${fileIndex}">
                                    <img src="${ev.target.result}" class="img-thumbnail"
                                        style="max-width:50px;max-height:35px;" title="${file.name}">
                                    <button type="button" class="delete-pasted" title="Sil">&times;</button>
                                </span>`
                            );
                            // Silme butonu olayı
                            $row.find(`.pasted-item[data-index="${fileIndex}"] .delete-pasted`).on('click', function(ev) {
                                ev.stopPropagation();
                                deletePastedImage($row, fileIndex);
                            });
                        };
                        reader.readAsDataURL(blob);

                        updateFileInfo($row);
                        e.preventDefault();
                    }
                }
            });
        }

        // Yapıştırılan görseli sil
        function deletePastedImage($row, index) {
            const rowId = $row.data('id');
            if (window.pastedFiles[rowId]) {
                window.pastedFiles[rowId][index] = null; // null yap (index'leri bozmamak için)
                $row.find(`.pasted-item[data-index="${index}"]`).remove();
                updateFileInfo($row);
            }
        }

        // Görsel önizleme modal'ını aç
        function openImagePreviewModal($row) {
            const rowId = $row.data('id');
            const fileInput = $row.find('.task-image')[0];
            const selectedFiles = fileInput ? Array.from(fileInput.files) : [];
            const pastedFilesList = (window.pastedFiles[rowId] || []).filter(f => f !== null);

            const allFiles = [...selectedFiles, ...pastedFilesList];

            if (allFiles.length === 0) {
                showResult('Bu task\'ta henüz görsel yok.', 'info');
                return;
            }

            const $thumbnails = $('#imageThumbnails');
            const $largePreview = $('#imageLargePreview');
            $thumbnails.empty();
            $largePreview.html('<p class="text-muted">Görüntülemek için bir görsel seçin</p>');

            // Thumbnails oluştur
            allFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const isPasted = index >= selectedFiles.length;
                    const $container = $(`
                        <div class="image-thumb-container mb-2">
                            <img src="${e.target.result}" class="image-thumb rounded" data-index="${index}" title="${file.name}">
                            <button type="button" class="delete-thumb" data-index="${index}" data-pasted="${isPasted}" title="Sil">&times;</button>
                        </div>
                    `);
                    $thumbnails.append($container);

                    // İlk görseli büyük göster
                    if (index === 0) {
                        showLargeImage(e.target.result, file.name);
                        $container.find('.image-thumb').addClass('active');
                    }

                    // Thumbnail tıklama
                    $container.find('.image-thumb').on('click', function() {
                        $('.image-thumb').removeClass('active');
                        $(this).addClass('active');
                        showLargeImage(e.target.result, file.name);
                    });

                    // Silme butonu (sadece yapıştırılanlar için çalışır)
                    $container.find('.delete-thumb').on('click', function() {
                        const idx = $(this).data('index');
                        const isPastedFile = $(this).data('pasted');
                        if (isPastedFile) {
                            const pastedIdx = idx - selectedFiles.length;
                            deletePastedImage($row, pastedIdx);
                            $(this).parent().remove();
                            // İlk kalan görseli göster
                            const $remaining = $('.image-thumb:first');
                            if ($remaining.length) {
                                $remaining.addClass('active').click();
                            } else {
                                $largePreview.html('<p class="text-muted">Görsel kalmadı</p>');
                            }
                        } else {
                            showResult('Seçilen dosyalar tarayıcı güvenliği nedeniyle silinemez. Dosya seçiciyi temizleyip tekrar seçin.', 'warning');
                        }
                    });
                };
                reader.readAsDataURL(file);
            });

            // Modal'ı aç
            new bootstrap.Modal('#imagePreviewModal').show();
        }

        // Büyük görsel göster
        function showLargeImage(src, name) {
            $('#imageLargePreview').html(`
                <img src="${src}" class="img-fluid rounded shadow" style="max-height:450px;" title="${name}">
                <p class="mt-2 text-muted small">${name}</p>
            `);
        }

        // Dosya bilgisini güncelle
        function updateFileInfo($row) {
            const fileInput = $row.find('.task-image')[0];
            const selectedFiles = fileInput ? fileInput.files.length : 0;
            const rowId = $row.data('id');
            const pastedCount = window.pastedFiles[rowId] ? window.pastedFiles[rowId].filter(f => f !== null).length : 0;
            const total = selectedFiles + pastedCount;

            const info = $row.find('.task-image-info');
            if (total > 0) {
                let text = '';
                if (selectedFiles > 0) text += `${selectedFiles} seçili`;
                if (pastedCount > 0) text += (text ? ' + ' : '') + `${pastedCount} yapıştırılmış`;
                info.text(text);
            } else {
                info.text('');
            }
        }

        window.deleteRow = function(btn) {
            const $row = $(btn).closest('tr');
            const rowId = $row.data('id');
            // Yapıştırılan dosyaları temizle
            if (window.pastedFiles[rowId]) {
                delete window.pastedFiles[rowId];
            }
            $row.remove();
            updateRowNumbers();
        };

        function updateRowNumbers() {
            $('#taskTableBody tr').each(function(index) {
                $(this).find('td:first').text(index + 1);
            });
        }

        $('#addTask').click(function() {
            addTaskRow();
            // JSON modundaysa, yeni task'ı JSON'a ekle ve kaydet
            if (isJsonMode && currentPageIndex >= 0) {
                syncUItoJson();
                if (jsonFileHandle) {
                    autoSaveJson();
                }
            }
        });

        // Test+Arayüz butonu - iki hazır task ekler
        $('#addTestArayuzTasks').click(function() {
            // Test task'ı
            addTaskRow(
                'dönüşümü tamamlanmasının ardından test edilecektir',
                '',
                'dönüşümünün tamamlanmasının ardından fonksiyonel testleri yapılacaktır.'
            );
            // Arayüz task'ı
            addTaskRow(
                'Arayüz Giydirme Çalışması',
                '',
                'Arayüz Giydirme Çalışması yapılacaktır.'
            );
            // JSON modundaysa kaydet
            if (isJsonMode && currentPageIndex >= 0) {
                syncUItoJson();
                if (jsonFileHandle) {
                    autoSaveJson();
                }
            }
        });

        addTaskRow();

        // ==================== Refinement JSON Import ====================

        // File System Access API destekli mi kontrol et
        const hasFileSystemAccess = 'showOpenFilePicker' in window;

        // JSON dosyasını yükle butonu
        $('#loadJsonBtn').click(async function() {
            // File System Access API varsa kullan (Chrome/Edge)
            if (hasFileSystemAccess) {
                try {
                    const [handle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'JSON Files',
                            accept: { 'application/json': ['.json'] }
                        }]
                    });
                    jsonFileHandle = handle;
                    const file = await handle.getFile();
                    loadRefinementJson(file);
                    showResult('Dosya yazma izni alındı. Değişiklikler otomatik kaydedilecek.', 'info', 3000);
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Dosya seçilemedi:', err);
                    }
                }
            } else {
                // Fallback: Normal file input kullan
                var fileInput = $('#jsonFileInput')[0];
                if (!fileInput.files || fileInput.files.length === 0) {
                    showResult('Lütfen bir JSON dosyası seçin.', 'warning');
                    return;
                }
                loadRefinementJson(fileInput.files[0]);
            }
        });

        // JSON dosyasını otomatik kaydet (File System Access API ile)
        async function autoSaveJson() {
            if (!jsonFileHandle || !loadedJsonData) return false;

            try {
                const writable = await jsonFileHandle.createWritable();
                await writable.write(JSON.stringify(loadedJsonData, null, 2));
                await writable.close();
                console.log('JSON otomatik kaydedildi');
                return true;
            } catch (err) {
                console.error('Otomatik kaydetme hatası:', err);
                return false;
            }
        }

        // Temizle butonu - Manuel moda dön
        $('#clearJsonBtn').click(function() {
            $('#jsonPreview').hide();
            $('#jsonLoadSection').show();
            $('#taskTableBody').empty();
            taskCounter = 0;
            window.pastedFiles = {};

            // State'i sıfırla
            loadedJsonData = null;
            currentPageIndex = -1;
            completedPages = {};
            jsonFileHandle = null;

            // Manuel moda geç
            exitJsonMode();

            addTaskRow(); // Boş bir satır ekle
            showResult('Task listesi temizlendi. Manuel moda geçildi.', 'info');

            // Navbar butonundan badge'i kaldır
            $('#openJsonImportBtn').find('.badge').remove();

            // JSON İndir butonunu gizle
            $('#downloadJsonBtn').hide();
        });

        // JSON İndir butonu
        $('#downloadJsonBtn').click(function() {
            if (!loadedJsonData) {
                showResult('İndirilecek JSON verisi yok.', 'warning');
                return;
            }

            // JSON'u indir
            var jsonStr = JSON.stringify(loadedJsonData, null, 2);
            var blob = new Blob([jsonStr], { type: 'application/json' });
            var url = URL.createObjectURL(blob);

            // Dosya adı oluştur (modulAdi veya tarih ile)
            var fileName = 'refinement_' + new Date().toISOString().slice(0, 10) + '.json';
            if (loadedJsonData.modulAdi) {
                fileName = loadedJsonData.modulAdi.replace(/[^a-zA-Z0-9]/g, '_') + '_updated.json';
            }

            var a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showResult('JSON dosyası indirildi: ' + fileName, 'success');
        });

        // JSON dosyasını oku ve parse et
        function loadRefinementJson(file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = JSON.parse(e.target.result);
                    validateAndProcessJson(data);
                } catch (err) {
                    showResult('Geçersiz JSON formatı: ' + err.message, 'danger');
                }
            };
            reader.readAsText(file);
        }

        // JSON'u doğrula ve işle
        function validateAndProcessJson(data) {
            // pages dizisi kontrolü
            if (!data.pages || !Array.isArray(data.pages)) {
                showResult('JSON formatı hatalı: pages dizisi bulunamadı', 'danger');
                return;
            }

            // JSON verisini sakla
            loadedJsonData = data;
            currentPageIndex = -1;
            completedPages = {};

            // Önizleme bilgilerini göster
            showJsonPreview(data);

            // JSON moduna geç
            enterJsonMode();

            // Sayfa navigasyonunu oluştur
            buildPageNavigation(data);

            // İlk sayfayı otomatik seç
            if (data.pages.length > 0) {
                selectPage(0);
            }

            showResult(data.pages.length + ' sayfa yüklendi. Sol panelden sayfa seçerek işlem yapabilirsiniz.', 'success');

            // Modal'ı otomatik kapat
            const modal = bootstrap.Modal.getInstance(document.getElementById('jsonImportModal'));
            if (modal) {
                modal.hide();
            }

            // Navbar butonuna badge ekle
            const existingBadge = $('#openJsonImportBtn').find('.badge');
            if (existingBadge.length > 0) {
                existingBadge.text(data.pages.length);
            } else {
                $('#openJsonImportBtn').append(' <span class="badge bg-light text-warning">' + data.pages.length + '</span>');
            }

            // JSON İndir butonunu göster (sadece File System Access API yoksa veya fallback için)
            if (!jsonFileHandle) {
                $('#downloadJsonBtn').show();
            } else {
                $('#downloadJsonBtn').hide();
            }
        }

        // JSON moduna gir
        function enterJsonMode() {
            isJsonMode = true;
            // JSON modu göstergelerini aktif et
            $('.json-mode-indicator').addClass('active');
            // Manuel mod göstergelerini gizle
            $('.manual-mode-indicator').addClass('hidden');
            // Task listesi panelini daralt (col-md-9)
            $('#taskListPanel').removeClass('col-md-12').addClass('col-md-9');
        }

        // Manuel moda dön
        function exitJsonMode() {
            isJsonMode = false;
            // JSON modu göstergelerini kapat
            $('.json-mode-indicator').removeClass('active');
            // Manuel mod göstergelerini göster
            $('.manual-mode-indicator').removeClass('hidden');
            // Task listesi panelini genişlet (col-md-12)
            $('#taskListPanel').removeClass('col-md-9').addClass('col-md-12');
            // Sayfa navigasyonunu temizle
            $('#pageNavContainer').html('<p class="text-muted text-center small">JSON yükleyin</p>');
        }

        // JSON önizleme bilgilerini göster
        function showJsonPreview(data) {
            var pageCount = data.pages.length;
            var taskCount = 0;

            // Modül isimlerini topla
            var modules = {};
            for (var i = 0; i < data.pages.length; i++) {
                var klasor = data.pages[i].klasor || 'diger';
                modules[klasor] = (modules[klasor] || 0) + 1;
                if (data.pages[i].tasks && data.pages[i].tasks.length) {
                    taskCount += data.pages[i].tasks.length;
                }
            }

            // Modül bilgisini formatla
            var modulInfo = Object.keys(modules).map(function(k) {
                return k.toUpperCase() + ' (' + modules[k] + ')';
            }).join(', ');

            $('#jsonModulInfo').text(modulInfo || 'Bilinmiyor');
            $('#jsonPageCount').text(pageCount);
            $('#jsonTaskCount').text(taskCount);
            $('#jsonPreview').show();
        }

        // Sayfa navigasyonunu oluştur
        function buildPageNavigation(data) {
            var $container = $('#pageNavContainer');
            $container.empty();

            // Sayfaları modüle göre grupla
            var modules = {};
            for (var i = 0; i < data.pages.length; i++) {
                var page = data.pages[i];
                var mod = (page.klasor || 'diger').toUpperCase();
                if (!modules[mod]) {
                    modules[mod] = [];
                }
                modules[mod].push({ page: page, index: i });
            }

            // Her modül için accordion oluştur
            var moduleKeys = Object.keys(modules);
            for (var m = 0; m < moduleKeys.length; m++) {
                var modName = moduleKeys[m];
                var modPages = modules[modName];

                // Modül başlığı
                var $moduleHeader = $('<div class="module-header" data-module="' + modName + '">' +
                    '<span><i class="bi bi-folder2-open me-2"></i>' + modName + '</span>' +
                    '<span class="badge bg-secondary">' + modPages.length + ' sayfa</span>' +
                '</div>');

                // Modül sayfaları container
                var $modulePages = $('<div class="module-pages" data-module-pages="' + modName + '"></div>');

                // Sayfaları ekle
                for (var p = 0; p < modPages.length; p++) {
                    var pageData = modPages[p];
                    var taskCount = pageData.page.tasks ? pageData.page.tasks.length : 0;

                    // Sayfadaki tüm tasklar oluşturulmuş mu kontrol et
                    var allTasksCreated = taskCount > 0 && pageData.page.tasks.every(function(t) { return t.created && t.jiraKey; });
                    var someTasksCreated = taskCount > 0 && pageData.page.tasks.some(function(t) { return t.created && t.jiraKey; });
                    var createdCount = pageData.page.tasks ? pageData.page.tasks.filter(function(t) { return t.created; }).length : 0;

                    // Eğer tüm tasklar oluşturulmuşsa completedPages'e ekle
                    if (allTasksCreated) {
                        completedPages[pageData.index] = true;
                    }

                    var statusIcon = allTasksCreated ? 'bi-check-circle-fill text-success' : (someTasksCreated ? 'bi-check-circle text-warning' : 'bi-circle');
                    var itemClass = allTasksCreated ? 'page-nav-item completed' : 'page-nav-item';
                    var badgeText = someTasksCreated ? createdCount + '/' + taskCount : taskCount;
                    var badgeClass = allTasksCreated ? 'badge bg-success' : (someTasksCreated ? 'badge bg-warning text-dark' : 'badge bg-light text-dark');

                    var $pageItem = $('<div class="' + itemClass + '" data-page-index="' + pageData.index + '">' +
                        '<span class="page-status-icon me-2"><i class="bi ' + statusIcon + '"></i></span>' +
                        '<span class="page-name">' + escapeHtml(pageData.page.sayfaAdi || pageData.page.dosyaAdi) + '</span>' +
                        '<span class="' + badgeClass + ' ms-auto">' + badgeText + '</span>' +
                    '</div>');

                    // Sayfa tıklama olayı
                    $pageItem.on('click', function() {
                        var idx = parseInt($(this).attr('data-page-index'));
                        selectPage(idx);
                    });

                    $modulePages.append($pageItem);
                }

                // Modül toggle olayı
                $moduleHeader.on('click', function() {
                    var mod = $(this).attr('data-module');
                    $('[data-module-pages="' + mod + '"]').slideToggle(200);
                });

                $container.append($moduleHeader);
                $container.append($modulePages);
            }

            // İlerleme badge'ini güncelle
            updatePageProgress();
        }

        // Sayfa seç ve yükle
        function selectPage(pageIndex) {
            if (!loadedJsonData || pageIndex < 0 || pageIndex >= loadedJsonData.pages.length) {
                return;
            }

            // Önceki sayfadaki değişiklikleri JSON'a kaydet
            if (currentPageIndex >= 0 && currentPageIndex !== pageIndex) {
                syncUItoJson();
                // Değişiklikler varsa otomatik kaydet
                if (jsonFileHandle) {
                    autoSaveJson();
                }
            }

            var page = loadedJsonData.pages[pageIndex];
            currentPageIndex = pageIndex;

            // Navigasyonda aktif sayfayı işaretle
            $('.page-nav-item').removeClass('active');
            $('.page-nav-item[data-page-index="' + pageIndex + '"]').addClass('active');

            // Title/Açıklama Başlangıcı'nı yukarıdaki input'lara yaz
            $('#titlePrefix').val(page.titlePrefix || '');
            $('#descriptionPrefix').val(page.descPrefix || '');

            // Aktif sayfa bilgisini göster
            $('#currentPageTitle').text(page.sayfaAdi || page.dosyaAdi);
            $('#currentPagePath').text((page.klasor || '') + '/' + (page.dosyaAdi || ''));
            $('#currentPageBadge').html('<span class="badge bg-light text-success">' + (pageIndex + 1) + '/' + loadedJsonData.pages.length + '</span>');

            // Sadece bu sayfanın task'larını tabloya yükle
            loadPageTasks(page);

            // Navigasyon butonlarını güncelle
            updateNavButtons();
        }

        // Sayfanın task'larını tabloya yükle
        function loadPageTasks(page) {
            // Mevcut satırları temizle
            $('#taskTableBody').empty();
            taskCounter = 0;
            window.pastedFiles = {};

            // Task'ları ekle
            if (page.tasks && page.tasks.length > 0) {
                for (var j = 0; j < page.tasks.length; j++) {
                    var task = page.tasks[j];
                    addTaskRow(
                        task.titleSuffix || '',    // Title Sonu
                        task.sure || '',           // Süre (boş olabilir)
                        task.descSuffix || ''      // Açıklama Sonu
                    );

                    // Eğer task zaten oluşturulmuşsa, satırı işaretle
                    if (task.created && task.jiraKey) {
                        var $lastRow = $('#taskTableBody tr:last');
                        $lastRow.addClass('table-success');
                        $lastRow.find('input').prop('disabled', true);
                        var jiraUrl = getJiraUrl();
                        var issueLink = jiraUrl ? '<a href="' + jiraUrl + '/browse/' + task.jiraKey + '" target="_blank" class="text-success text-decoration-none">' + task.jiraKey + '</a>' : task.jiraKey;

                        // Oluşturma tarihini formatla
                        var createdAtText = '';
                        if (task.createdAt) {
                            var date = new Date(task.createdAt);
                            createdAtText = ' <span class="text-muted">(' + date.toLocaleDateString('tr-TR') + ' ' + date.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'}) + ')</span>';
                        }

                        $lastRow.find('.task-title-suffix').after(
                            '<br><small class="text-success"><i class="bi bi-check-circle"></i> ' + issueLink + createdAtText + '</small>'
                        );
                    }
                }
            }
        }

        // Navigasyon butonlarını güncelle
        function updateNavButtons() {
            var prevBtn = $('#prevPageBtn');
            var nextBtn = $('#nextPageBtn');

            // Önceki butonu
            if (currentPageIndex <= 0) {
                prevBtn.prop('disabled', true);
            } else {
                prevBtn.prop('disabled', false);
            }

            // Sonraki butonu
            if (!loadedJsonData || currentPageIndex >= loadedJsonData.pages.length - 1) {
                nextBtn.prop('disabled', true);
            } else {
                nextBtn.prop('disabled', false);
            }
        }

        // İlerleme badge'ini güncelle
        function updatePageProgress() {
            if (!loadedJsonData) return;

            var completedCount = Object.keys(completedPages).length;
            var totalCount = loadedJsonData.pages.length;
            $('#pageProgressBadge').text(completedCount + '/' + totalCount);

            // Navigasyondaki ikonları ve badge'leri güncelle
            for (var i = 0; i < totalCount; i++) {
                var $item = $('.page-nav-item[data-page-index="' + i + '"]');
                var $icon = $item.find('.page-status-icon i');
                var $badge = $item.find('.badge');

                // Sayfa task bilgilerini al
                var page = loadedJsonData.pages[i];
                var taskCount = (page.tasks && page.tasks.length) || 0;
                var createdCount = 0;
                if (page.tasks) {
                    for (var t = 0; t < page.tasks.length; t++) {
                        if (page.tasks[t].created) createdCount++;
                    }
                }

                var allTasksCreated = taskCount > 0 && createdCount === taskCount;
                var someTasksCreated = createdCount > 0;

                if (allTasksCreated || completedPages[i]) {
                    $item.addClass('completed');
                    $icon.removeClass('bi-circle bi-check-circle').addClass('bi-check-circle-fill text-success');
                    $badge.removeClass('bg-light bg-warning text-dark').addClass('bg-success').text(createdCount + '/' + taskCount);
                } else if (someTasksCreated) {
                    $item.removeClass('completed');
                    $icon.removeClass('bi-circle bi-check-circle-fill').addClass('bi-check-circle text-warning');
                    $badge.removeClass('bg-light bg-success').addClass('bg-warning text-dark').text(createdCount + '/' + taskCount);
                } else {
                    $item.removeClass('completed');
                    $icon.removeClass('bi-check-circle-fill bi-check-circle text-success text-warning').addClass('bi-circle');
                    $badge.removeClass('bg-success bg-warning').addClass('bg-light text-dark').text(taskCount);
                }
            }
        }

        // Sayfayı tamamlandı olarak işaretle
        function markPageAsCompleted(pageIndex) {
            completedPages[pageIndex] = true;
            updatePageProgress();
        }

        // Sonraki sayfa butonu
        $('#nextPageBtn').click(function() {
            if (loadedJsonData && currentPageIndex < loadedJsonData.pages.length - 1) {
                selectPage(currentPageIndex + 1);
            }
        });

        // Önceki sayfa butonu
        $('#prevPageBtn').click(function() {
            if (currentPageIndex > 0) {
                selectPage(currentPageIndex - 1);
            }
        });

        // Bu Sayfayı Oluştur butonu
        $('#createPageTasksBtn').click(function() {
            createCurrentPageTasks();
        });

        // UI'daki değişiklikleri JSON'a senkronize et
        function syncUItoJson() {
            if (!loadedJsonData || currentPageIndex < 0) return;

            var page = loadedJsonData.pages[currentPageIndex];
            if (!page) return;

            // tasks dizisi yoksa oluştur
            if (!page.tasks) {
                page.tasks = [];
            }

            // UI'daki task satırlarını döngüyle gez
            $('#taskTableBody tr').each(function(index) {
                var $row = $(this);
                var titleSuffix = $row.find('.task-title-suffix').val().trim();
                var sure = $row.find('.task-hours').val().trim();
                var descSuffix = $row.find('.task-desc-suffix').val().trim();

                if (index < page.tasks.length) {
                    // Mevcut task'ı güncelle (oluşturulmamışsa)
                    if (!page.tasks[index].created) {
                        page.tasks[index].titleSuffix = titleSuffix;
                        page.tasks[index].sure = sure;
                        page.tasks[index].descSuffix = descSuffix;
                    }
                } else {
                    // Yeni task ekle
                    page.tasks.push({
                        titleSuffix: titleSuffix,
                        sure: sure,
                        descSuffix: descSuffix,
                        created: false
                    });
                }
            });

            // Silinen satırlar varsa (UI'da daha az satır varsa)
            var uiRowCount = $('#taskTableBody tr').length;
            if (uiRowCount < page.tasks.length) {
                // Oluşturulmamış task'ları kaldır (sondan başlayarak)
                for (var i = page.tasks.length - 1; i >= uiRowCount; i--) {
                    if (!page.tasks[i].created) {
                        page.tasks.splice(i, 1);
                    }
                }
            }
        }

        // Aktif sayfanın task'larını oluştur
        async function createCurrentPageTasks() {
            if (!isJsonMode || currentPageIndex < 0) {
                showResult('Lütfen önce bir sayfa seçin.', 'warning');
                return;
            }

            // UI değişikliklerini JSON'a senkronize et
            syncUItoJson();

            // Daha önce oluşturulmuş task'ların key'lerini ve oluşturulmamış task'ların index'lerini al
            var existingKeys = [];
            var uncreatedTaskIndices = []; // JSON'daki oluşturulmamış task'ların index'leri
            var currentPage = loadedJsonData.pages[currentPageIndex];
            if (currentPage && currentPage.tasks) {
                for (var t = 0; t < currentPage.tasks.length; t++) {
                    if (currentPage.tasks[t].created && currentPage.tasks[t].jiraKey) {
                        existingKeys.push(currentPage.tasks[t].jiraKey);
                    } else {
                        uncreatedTaskIndices.push(t);
                    }
                }
            }

            var tasks = collectTaskData();

            if (tasks.length === 0) {
                showResult('Bu sayfada oluşturulacak task yok.', 'warning');
                return;
            }

            var url = getJiraUrl();
            var token = $('#jiraToken').val().trim();
            var projectKey = $('#projectKey').val();

            if (!url || !token) {
                showResult('Lütfen bağlantı ayarlarını doldurun.', 'danger');
                return;
            }

            if (!projectKey) {
                showResult('Lütfen proje seçin.', 'danger');
                return;
            }

            var btn = $('#createPageTasksBtn');
            var progressContainer = $('#taskCreationProgress');
            var progressBar = $('#taskProgressBar');
            var progressText = $('#taskProgressText');

            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Oluşturuluyor...');
            progressContainer.removeClass('d-none');
            progressBar.css('width', '0%').text('0%');
            progressText.text('Task oluşturuluyor... (0/' + tasks.length + ')');

            var createdKeys = [];
            var results = [];

            // Progress güncelleme fonksiyonu
            function updateProgress(current, total, currentTaskSummary) {
                var percent = Math.round((current / total) * 100);
                progressBar.css('width', percent + '%').text(percent + '%');
                progressText.html('Task oluşturuluyor... (' + current + '/' + total + ')<br><small class="text-muted">' + currentTaskSummary + '</small>');
            }

            try {
                for (var i = 0; i < tasks.length; i++) {
                    // Progress'i güncelle (task başlamadan önce)
                    updateProgress(i, tasks.length, tasks[i].summary.substring(0, 50) + '...');

                    try {
                        var result = await createJiraIssue(tasks[i]);
                        createdKeys.push(result.key);

                        // Görselleri yükle
                        var attachmentCount = 0;
                        if (tasks[i].files && tasks[i].files.length > 0) {
                            for (var f = 0; f < tasks[i].files.length; f++) {
                                var uploaded = await uploadAttachment(result.key, tasks[i].files[f]);
                                if (uploaded) attachmentCount++;
                            }
                        }

                        var attachmentInfo = attachmentCount > 0 ? ' (' + attachmentCount + ' görsel eklendi)' : '';

                        // JSON'daki gerçek task index'ini bul
                        var jsonTaskIndex = uncreatedTaskIndices[i];
                        results.push({ success: true, key: result.key, summary: tasks[i].summary, attachmentInfo: attachmentInfo, taskIndex: jsonTaskIndex });

                        // JSON'daki task'a jiraKey ve created bilgisi ekle
                        if (loadedJsonData && loadedJsonData.pages[currentPageIndex] && loadedJsonData.pages[currentPageIndex].tasks[jsonTaskIndex]) {
                            loadedJsonData.pages[currentPageIndex].tasks[jsonTaskIndex].created = true;
                            loadedJsonData.pages[currentPageIndex].tasks[jsonTaskIndex].jiraKey = result.key;
                            loadedJsonData.pages[currentPageIndex].tasks[jsonTaskIndex].createdAt = new Date().toISOString();
                        }

                        // Progress'i güncelle (task tamamlandıktan sonra)
                        updateProgress(i + 1, tasks.length, result.key + ' oluşturuldu');
                    } catch (err) {
                        results.push({ success: false, error: err.message, summary: tasks[i].summary, taskIndex: i });
                        updateProgress(i + 1, tasks.length, 'Hata: ' + tasks[i].summary.substring(0, 30) + '...');
                    }
                }

                // Tüm key'leri birleştir (eski + yeni)
                // existingKeys yukarıda collectTaskData'dan önce toplandı
                var allKeys = existingKeys.concat(createdKeys);

                // Task'ları birbirine bağla (yeni task'ları hem kendi aralarında hem de eski task'larla)
                if (createdKeys.length > 0 && allKeys.length > 1) {
                    progressBar.addClass('bg-info').removeClass('bg-primary');
                    progressText.html('<i class="bi bi-link-45deg"></i> Task\'lar birbirine bağlanıyor...');

                    var linkedPairs = {}; // Zaten bağlanmış çiftleri takip et

                    // Yeni oluşturulan her task'ı diğer tüm task'larla bağla
                    for (var n = 0; n < createdKeys.length; n++) {
                        for (var a = 0; a < allKeys.length; a++) {
                            var key1 = createdKeys[n];
                            var key2 = allKeys[a];

                            // Kendisiyle bağlama
                            if (key1 === key2) continue;

                            // Çift zaten bağlandıysa atla (A-B ve B-A aynı)
                            var pairKey = [key1, key2].sort().join('-');
                            if (linkedPairs[pairKey]) continue;

                            await linkIssues(key1, key2);
                            linkedPairs[pairKey] = true;
                        }
                    }
                }

                // Başarılı taskları history'ye kaydet
                var successfulTasks = results.filter(function(r) { return r.success; }).map(function(r) {
                    return { key: r.key, summary: r.summary };
                });

                if (successfulTasks.length > 0) {
                    saveToHistory(successfulTasks, getJiraUrl());
                }

                // Sonuç mesajı oluştur
                var html = '<strong>' + successfulTasks.length + '/' + results.length + ' task oluşturuldu</strong>';

                var hasError = results.some(function(r) { return !r.success; });

                // Sayfa başarıyla tamamlandıysa işaretle
                if (!hasError) {
                    markPageAsCompleted(currentPageIndex);

                    // JSON dosyasını otomatik kaydet
                    if (jsonFileHandle) {
                        autoSaveJson().then(function(saved) {
                            if (saved) {
                                showResult('JSON dosyası otomatik güncellendi.', 'info', 2000);
                            }
                        });
                    }

                    // UI'ı güncelle - oluşturulan task'ları yeşil göster
                    loadPageTasks(loadedJsonData.pages[currentPageIndex]);
                } else {
                    html += '<br><small class="text-danger">Bazı tasklar oluşturulamadı</small>';
                }

                showResult(html, hasError ? 'warning' : 'success', 15000);

            } catch (err) {
                showResult('Hata oluştu: ' + err.message, 'danger');
            }

            // Progress bar'ı gizle ve butonu resetle
            progressContainer.addClass('d-none');
            btn.prop('disabled', false).html('<i class="bi bi-cloud-upload"></i> Bu Sayfayı Oluştur');
        }

        // selectPage'i global yap (toast içindeki buton için)
        window.selectPage = selectPage;

        // ==================== Task Verilerini Topla ====================

        // collectTaskData - Global prefix'ler kullanılıyor
        function collectTaskData() {
            var tasks = [];

            // Global prefix değerlerini al (yukarıdaki input'lardan)
            var globalTitlePrefix = $('#titlePrefix').val().trim();
            var globalDescPrefix = $('#descriptionPrefix').val().trim();

            $('#taskTableBody tr').each(function() {
                var $row = $(this);

                // Zaten oluşturulmuş task'ları atla (yeşil satırlar)
                if ($row.hasClass('table-success')) {
                    return; // continue
                }

                var rowId = $row.data('id');

                // Sadece suffix değerlerini al (prefix artık tabloda yok)
                var titleSuffix = $row.find('.task-title-suffix').val().trim();
                var descSuffix = $row.find('.task-desc-suffix').val().trim();
                var hours = $row.find('.task-hours').val().trim();

                var fileInput = $row.find('.task-image')[0];
                var selectedFiles = fileInput ? Array.from(fileInput.files) : [];
                var pastedFilesList = (window.pastedFiles[rowId] || []).filter(function(f) { return f !== null; });

                // Seçilen ve yapıştırılan dosyaları birleştir
                var allFiles = selectedFiles.concat(pastedFilesList);

                // Title: global prefix + suffix birleştir (araya boşluk koy)
                var fullTitle = globalTitlePrefix && titleSuffix
                    ? globalTitlePrefix + ' ' + titleSuffix
                    : (globalTitlePrefix || titleSuffix);

                // Description: global prefix + suffix birleştir (araya boşluk koy)
                var fullDesc = globalDescPrefix && descSuffix
                    ? globalDescPrefix + ' ' + descSuffix
                    : (globalDescPrefix || descSuffix);

                if (fullTitle) {
                    // Süre kontrolü: boş veya 0'dan büyük değer varsa kullan, yoksa boş string
                    const taskHours = hours && parseInt(hours) > 0 ? hours : '';

                    tasks.push({
                        summary: fullTitle,
                        description: fullDesc || '',
                        hours: taskHours,
                        files: allFiles
                    });
                }
            });

            return tasks;
        }

        // ==================== Önizleme ====================

        // Ortak ayarları dinamik olarak sayfadan topla
        function collectCommonSettings() {
            const settings = [];

            // Ortak Task Bilgileri kartındaki tüm form elemanlarını otomatik tara
            // Card header'ı "Ortak Task Bilgileri" olan kartı bul
            const $commonCard = $('.card-header:contains("Ortak Task Bilgileri")').closest('.card');

            // Karttaki tüm select ve input elemanlarını tara (buton ve textarea hariç)
            $commonCard.find('select, input:not([type="button"])').each(function() {
                const $el = $(this);
                const id = $el.attr('id');

                // Prefix/description alanlarını atla (ayrı gösterilecek)
                if (id === 'titlePrefix' || id === 'descriptionPrefix') return;

                const $label = $el.closest('.mb-3').find('.form-label');
                const labelText = $label.text().replace('*', '').replace(/\s+/g, ' ').trim();
                let value = '';

                if ($el.is('select')) {
                    const selectedOption = $el.find('option:selected');
                    value = selectedOption.text();
                    // Placeholder seçiliyse boş göster
                    if (selectedOption.val() === '' || value.startsWith('--') || value.includes('Seçin')) {
                        value = '';
                    }
                } else {
                    value = $el.val();
                }

                if (labelText && labelText !== '') {
                    settings.push({ label: labelText, value: value || '-' });
                }
            });

            return settings;
        }

        $('#previewBtn').click(function() {
            const tasks = collectTaskData();

            if (tasks.length === 0) {
                showResult('Lütfen en az bir task ekleyin.', 'warning');
                return;
            }

            // Ortak ayarları dinamik olarak al
            const commonSettings = collectCommonSettings();
            const titlePrefix = $('#titlePrefix').val().trim();
            const descPrefix = $('#descriptionPrefix').val().trim();

            // Ortak bilgiler bölümü
            let settingsHtml = commonSettings.map(s =>
                `<strong>${s.label}:</strong> ${s.value}`
            ).join('<br>');

            if (titlePrefix) {
                settingsHtml += `<br><strong>Title Başlangıcı:</strong> ${titlePrefix}`;
            }
            if (descPrefix) {
                settingsHtml += `<br><strong>Açıklama Başlangıcı:</strong> ${descPrefix.substring(0, 50)}${descPrefix.length > 50 ? '...' : ''}`;
            }

            let html = `<div class="alert alert-info">${settingsHtml}</div>`;

            tasks.forEach((task, index) => {
                const fileCount = task.files ? task.files.length : 0;
                const fileInfo = fileCount > 0 ? `<span class="badge bg-info">${fileCount} görsel</span>` : '';
                html += `
                    <div class="task-preview">
                        <h6><strong>Task ${index + 1}</strong> ${fileInfo}</h6>
                        <p><strong>Title:</strong> ${task.summary}</p>
                        <p><strong>Süre:</strong> ${task.hours} saat</p>
                        <p><strong>Açıklama:</strong> ${task.description || '-'}</p>
                    </div>
                `;
            });

            $('#previewContent').html(html);
            new bootstrap.Modal('#previewModal').show();
        });

        // ==================== Jira API Entegrasyonu (Python Backend) ====================

        async function createJiraIssue(task) {
            const projectKey = $('#projectKey').val();
            const component = $('#component').val();
            const issueType = $('#issueType').val() || 'Task';
            const epicLink = $('#epicLink').val();
            const priority = $('#priority').val();
            const customer = $('#customer').val().trim();
            const teamName = $('#teamName').val().trim();

            const issueData = {
                fields: {
                    project: { key: projectKey },
                    summary: task.summary,
                    description: task.description,
                    issuetype: { name: issueType }
                }
            };

            // Timetracking sadece hours varsa ekle
            if (task.hours && task.hours.toString().trim() !== '') {
                issueData.fields.timetracking = {
                    originalEstimate: `${task.hours}h`
                };
            }

            // Zorunlu özel alanlar (select tipi - obje formatında gönderilmeli)
            if (customer) {
                issueData.fields.customfield_10901 = { value: customer };
            }
            if (teamName) {
                issueData.fields.customfield_11000 = { value: teamName };
            }

            // Öncelik - ID ile gönder
            if (priority && priority !== '') {
                issueData.fields.priority = { id: priority };
            }

            if (component) {
                issueData.fields.components = [{ name: component }];
            }

            // Epic Link - dinamik field ID kullan
            if (epicLink && window.epicLinkFieldId) {
                issueData.fields[window.epicLinkFieldId] = epicLink;
            }

            return await jiraFetch('issue', {
                method: 'POST',
                body: JSON.stringify(issueData)
            });
        }

        async function linkIssues(inwardKey, outwardKey) {
            const linkData = {
                type: { name: 'Relates' },
                inwardIssue: { key: inwardKey },
                outwardIssue: { key: outwardKey }
            };

            try {
                await $.ajax({
                    url: '/api/jira-link',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: {
                        'X-Jira-Url': getJiraUrl(),
                        'Authorization': getAuthHeader()
                    },
                    data: JSON.stringify(linkData)
                });
                return true;
            } catch {
                return false;
            }
        }

        // Dosya yükleme fonksiyonu
        async function uploadAttachment(issueKey, file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                await $.ajax({
                    url: `/api/jira-attachment/${issueKey}`,
                    type: 'POST',
                    headers: {
                        'X-Jira-Url': getJiraUrl(),
                        'Authorization': getAuthHeader()
                    },
                    data: formData,
                    processData: false,
                    contentType: false
                });
                return true;
            } catch (err) {
                console.error(`Dosya yükleme hatası (${issueKey}):`, err);
                return false;
            }
        }

        async function createAllTasks() {
            const tasks = collectTaskData();

            if (tasks.length === 0) {
                showResult('Lütfen en az bir task ekleyin.', 'warning');
                return;
            }

            const url = getJiraUrl();
            const token = $('#jiraToken').val().trim();
            const projectKey = $('#projectKey').val();

            if (!url || !token) {
                showResult('Lütfen bağlantı ayarlarını doldurun.', 'danger');
                return;
            }

            if (!projectKey) {
                showResult('Lütfen proje seçin.', 'danger');
                return;
            }

            const progressContainer = $('#manualTaskProgress');
            const progressBar = $('#manualProgressBar');
            const progressText = $('#manualProgressText');

            $('#createBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Oluşturuluyor...');
            progressContainer.removeClass('d-none');
            progressBar.css('width', '0%').text('0%').removeClass('bg-info');
            progressText.text(`Task oluşturuluyor... (0/${tasks.length})`);

            const createdKeys = [];
            const results = [];

            // Progress güncelleme fonksiyonu
            function updateManualProgress(current, total, currentTaskSummary) {
                const percent = Math.round((current / total) * 100);
                progressBar.css('width', percent + '%').text(percent + '%');
                progressText.html(`Task oluşturuluyor... (${current}/${total})<br><small class="text-muted">${currentTaskSummary}</small>`);
            }

            try {
                for (let i = 0; i < tasks.length; i++) {
                    // Progress'i güncelle (task başlamadan önce)
                    updateManualProgress(i, tasks.length, tasks[i].summary.substring(0, 50) + '...');

                    try {
                        const result = await createJiraIssue(tasks[i]);
                        createdKeys.push(result.key);

                        // Görselleri yükle
                        let attachmentCount = 0;
                        if (tasks[i].files && tasks[i].files.length > 0) {
                            for (const file of tasks[i].files) {
                                const uploaded = await uploadAttachment(result.key, file);
                                if (uploaded) attachmentCount++;
                            }
                        }

                        const attachmentInfo = attachmentCount > 0 ? ` (${attachmentCount} görsel eklendi)` : '';
                        results.push({ success: true, key: result.key, summary: tasks[i].summary, attachmentInfo });

                        // Progress'i güncelle (task tamamlandıktan sonra)
                        updateManualProgress(i + 1, tasks.length, `${result.key} oluşturuldu`);
                    } catch (err) {
                        results.push({ success: false, error: err.message, summary: tasks[i].summary });
                        updateManualProgress(i + 1, tasks.length, `Hata: ${tasks[i].summary.substring(0, 30)}...`);
                    }
                }

                // Task'ları birbirine bağla
                if (createdKeys.length > 1) {
                    progressBar.addClass('bg-info');
                    progressText.html('<i class="bi bi-link-45deg"></i> Task\'lar birbirine bağlanıyor...');
                    for (let i = 0; i < createdKeys.length - 1; i++) {
                        for (let j = i + 1; j < createdKeys.length; j++) {
                            await linkIssues(createdKeys[i], createdKeys[j]);
                        }
                    }
                }

                // Başarılı taskları history'ye kaydet
                const successfulTasks = results.filter(r => r.success).map(r => ({
                    key: r.key,
                    summary: r.summary
                }));

                if (successfulTasks.length > 0) {
                    saveToHistory(successfulTasks, getJiraUrl());
                }

                // Sonuç mesajı oluştur
                let html = `<strong>${successfulTasks.length}/${results.length} task oluşturuldu</strong><br>`;
                results.forEach(r => {
                    if (r.success) {
                        html += `<a href="${getJiraUrl()}/browse/${r.key}" target="_blank" class="text-decoration-none">${r.key}</a>${r.attachmentInfo || ''} `;
                    }
                });

                if (createdKeys.length > 1) {
                    html += `<br><small><i class="bi bi-link-45deg"></i> ${createdKeys.length} task bağlandı</small>`;
                }

                const hasError = results.some(r => !r.success);
                if (hasError) {
                    html += `<br><small class="text-danger">Bazı tasklar oluşturulamadı</small>`;
                }

                showResult(html, hasError ? 'warning' : 'success', 10000);

            } catch (err) {
                showResult(`Hata oluştu: ${err.message}`, 'danger');
            }

            // Progress bar'ı gizle ve butonu resetle
            progressContainer.addClass('d-none');
            $('#createBtn').prop('disabled', false).html('<i class="bi bi-cloud-upload"></i> Tümünü Oluştur');
        }

        $('#createBtn').click(createAllTasks);
        $('#createFromPreview').click(function() {
            bootstrap.Modal.getInstance('#previewModal').hide();
            createAllTasks();
        });

        // ==================== Toast Bildirimleri ====================

        // Event delegation - document seviyesinde bir kez bind et
        $(document).on('click', '.toast-close-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const $toast = $(this).closest('.custom-toast');
            const toastId = $toast.attr('id');
            if (toastId) {
                closeToast(toastId);
            }
        });

        function showResult(message, type, duration = 5000) {
            const toastId = 'toast_' + Date.now();
            const icons = {
                success: 'bi-check-circle-fill text-success',
                danger: 'bi-x-circle-fill text-danger',
                warning: 'bi-exclamation-triangle-fill text-warning',
                info: 'bi-info-circle-fill text-info'
            };

            const toast = $(`
                <div class="custom-toast toast-${type}" id="${toastId}">
                    <div class="d-flex align-items-start p-3">
                        <i class="bi ${icons[type]} me-2 mt-1"></i>
                        <div class="flex-grow-1">${message}</div>
                        <button type="button" class="toast-close-btn" title="Kapat">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
            `);

            $('#toastContainer').append(toast);

            // Otomatik kapanma
            if (duration > 0) {
                setTimeout(() => closeToast(toastId), duration);
            }
        }

        window.closeToast = function(toastId) {
            const toast = $(`#${toastId}`);
            if (toast.length && !toast.hasClass('hiding')) {
                toast.addClass('hiding');
                setTimeout(() => toast.remove(), 300);
            }
        };

        // ==================== Task Geçmişi (History) ====================

        const HISTORY_KEY = 'jira_task_history';

        function getHistory() {
            const data = localStorage.getItem(HISTORY_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveToHistory(tasks, jiraUrl) {
            const history = getHistory();
            const entry = {
                id: Date.now(),
                date: new Date().toLocaleString('tr-TR'),
                jiraUrl: jiraUrl,
                tasks: tasks
            };
            history.unshift(entry); // En yenisi başa

            // Toplam task sayısını hesapla
            let totalTasks = history.reduce((sum, e) => sum + e.tasks.length, 0);

            // 500 task'tan fazlaysa, en eskiden entry'leri sil (tek tek)
            while (totalTasks > 500 && history.length > 1) {
                const removed = history.pop();
                totalTasks -= removed.tasks.length;
            }

            try {
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            } catch (e) {
                // localStorage dolu ise eski kayıtları sil
                if (e.name === 'QuotaExceededError') {
                    // Toplam 100 task'a düşür
                    while (totalTasks > 100 && history.length > 1) {
                        const removed = history.pop();
                        totalTasks -= removed.tasks.length;
                    }
                    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                    showResult('Depolama alanı doldu, eski kayıtlar temizlendi.', 'warning');
                }
            }
            updateHistoryCount();
        }

        function updateHistoryCount() {
            const count = getHistory().reduce((sum, entry) => sum + entry.tasks.length, 0);
            $('#historyCount').text(count);
        }

        function renderHistory() {
            const history = getHistory();
            const $content = $('#historyContent');

            if (history.length === 0) {
                $content.html('<p class="text-muted text-center">Henüz oluşturulmuş task yok.</p>');
                return;
            }

            let html = '';
            history.forEach(entry => {
                html += `<div class="history-item">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="history-date"><i class="bi bi-calendar"></i> ${entry.date}</span>
                        <span class="badge bg-primary">${entry.tasks.length} task</span>
                    </div>
                    <ul class="history-task-list">`;

                entry.tasks.forEach(task => {
                    html += `<li>
                        <a href="${entry.jiraUrl}/browse/${task.key}" target="_blank" class="history-task-key">
                            <i class="bi bi-box-arrow-up-right"></i> ${task.key}
                        </a>
                        <span class="history-task-summary">${task.summary}</span>
                    </li>`;
                });

                html += `</ul></div>`;
            });

            $content.html(html);
        }

        // History buton
        $('#historyBtn').click(function() {
            renderHistory();
            new bootstrap.Modal('#historyModal').show();
        });

        // Geçmişi temizle
        $('#clearHistory').click(function() {
            if (confirm('Tüm task geçmişi silinecek. Emin misiniz?')) {
                localStorage.removeItem(HISTORY_KEY);
                updateHistoryCount();
                renderHistory();
                showResult('Task geçmişi temizlendi.', 'info');
            }
        });

        // Sayfa yüklendiğinde history sayısını güncelle
        updateHistoryCount();

        // Sayfa yüklendiğinde bağlantı varsa verileri otomatik yükle
        if ($('#jiraUrl').val() && $('#jiraToken').val()) {
            setTimeout(() => {
                $('#loadFromApi').click();
            }, 1000);
        }
    });
    </script>
</body>
</html>
